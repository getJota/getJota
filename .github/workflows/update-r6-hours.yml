name: Update R6 Siege Hours

on:
  schedule:
    - cron: '0 6 * * *'   # Corre todos los dÃ­as a las 06:00 UTC
  workflow_dispatch:

jobs:
  update-hours:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch playtime from Steam and update README
        env:
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          STEAM_ID: ${{ secrets.STEAM_ID }}
        run: |
          set -euo pipefail
          APPID=359550

          echo "ðŸ“¡ Consultando API de Steam..."
          URL="https://api.steampowered.com/IPlayerService/GetOwnedGames/v1/?key=${STEAM_API_KEY}&steamid=${STEAM_ID}&include_appinfo=false&include_played_free_games=true&appids_filter[0]=${APPID}"
          RESP=$(curl -s "$URL")
          echo "âœ… Respuesta de la API:"
          echo "$RESP" | jq .

          MINUTES=$(echo "$RESP" | jq -r '.response.games[0].playtime_forever // 0')

          if ! echo "$MINUTES" | grep -Eq '^[0-9]+$'; then
            echo "âš ï¸ No se encontraron minutos vÃ¡lidos, usando 0."
            MINUTES=0
          fi

          HOURS=$(( (MINUTES + 30) / 60 ))
          DATE=$(date -u +%F)

          echo "â±ï¸ Minutos totales: $MINUTES"
          echo "ðŸ•’ Horas (redondeadas): $HOURS"
          echo "ðŸ“… Fecha: $DATE"

          # Crear el JSON de estadÃ­sticas
          printf '{ "hours": %d, "minutes": %d, "last_updated": "%s" }\n' "$HOURS" "$MINUTES" "$DATE" > r6_stats.json
          echo "âœ… Archivo r6_stats.json generado:"
          cat r6_stats.json

          # Actualizar el README usando AWK (mÃ¡s seguro que sed)
          awk -v h="$HOURS" -v d="$DATE" '
            {
              gsub(/<span id="r6-hours">.*<\/span>/, "<span id=\"r6-hours\">`" h "` horas</span>")
              gsub(/<span id="r6-last">.*<\/span>/, "<span id=\"r6-last\">`" d "`</span>")
              print
            }
          ' README.md > README.tmp && mv README.tmp README.md
          echo "âœ… README actualizado."

      - name: Commit and push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          branch: main
          message: "ci: actualizar horas de juego Rainbow Six Siege"
          file_pattern: |
            README.md
            r6_stats.json
