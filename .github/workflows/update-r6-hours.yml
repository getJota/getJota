name: Update R6 Siege Hours

on:
  schedule:
    - cron: '0 6 * * *'   # Corre todos los d√≠as a las 06:00 UTC
  workflow_dispatch:

jobs:
  update-hours:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Fetch playtime from Steam and update README
        env:
          STEAM_API_KEY: ${{ secrets.STEAM_API_KEY }}
          STEAM_ID: ${{ secrets.STEAM_ID }}
        run: |
          set -e
          APPID=359550

          # Llamada a Steam API para obtener minutos jugados
          RESP=$(curl -s "https://api.steampowered.com/IPlayerService/GetOwnedGames/v1/?key=${STEAM_API_KEY}&steamid=${STEAM_ID}&include_appinfo=false&include_played_free_games=true&appids_filter[0]=${APPID}")

          # Extraer minutos jugados (o 0 si no hay resultado)
          MINUTES=$(echo "$RESP" | jq -r '.response.games[0].playtime_forever // 0')

          # Calcular horas redondeadas
          HOURS=$(python3 - <<PY
import math
print(round(int($MINUTES)/60))
PY
)

          DATE=$(date -u +%F)
          echo "Horas jugadas: $HOURS"
          echo "√öltima actualizaci√≥n: $DATE"

          # Crear o actualizar el archivo JSON
          echo "{\"hours\": $HOURS, \"last_updated\": \"$DATE\"}" > r6_stats.json

          # Actualizar la secci√≥n del README
          if grep -q "## üéÆ Horas jugadas ‚Äî Rainbow Six Siege" README.md; then
            awk -v h="$HOURS" -v d="$DATE" '
              /## üéÆ Horas jugadas ‚Äî Rainbow Six Siege/ {print; getline; getline; print "**Total:** " h " horas  "; print "*√öltima actualizaci√≥n:* " d; next}
              {print}
            ' README.md > README.tmp && mv README.tmp README.md
          else
            echo -e "\n## üéÆ Horas jugadas ‚Äî Rainbow Six Siege\n**Total:** $HOURS horas  \n*√öltima actualizaci√≥n:* $DATE\n" >> README.md
          fi

      - name: Commit and push changes
        uses: ad-m/github-push-action@v0.6.0
        with:
          branch: main
          message: "ci: actualizar horas de juego Rainbow Six Siege"
          file_pattern: |
            README.md
            r6_stats.json

